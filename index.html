<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>大屏Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="https://unpkg.com/spritejs/dist/spritejs.min.js"></script>
  <script src="./assets/data/map_data_china.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #404a59;
      height: 100%;
      width: 100%;
    }

    #app {
      width: 1000px;
      height: 600px;
      margin: 0 auto;
      margin-top: 50px;
    }

    .paper {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="paper" id="paper"></div>
  </div>
</body>
<script>
  let svgData = chinaSVGData
  const { Path } = spritejs
  const staticFloatProvs = [
    {
      name: '新疆',
      height: 10
    },
    {
      name: '青海',
      height: 20
    },
    {
      name: '西藏',
      height: 10
    },
    {
      name: '内蒙古',
      height: 10
    },
  ]

  new Vue({
    el: '#app',
    data() {
      return {
        // 背景层
        bgLayer: null,

        // 固定悬浮层
        staticLayer: null,

        // 点击展示层
        activeSprites: [],
        activeLayer: null,
      }
    },
    beforeDestory() {
      if (this.bgLayer) {
        this.bgLayer = null
      }
      if (this.staticLayer) {
        this.staticLayer = null
      }
      if (this.activeLayer) {
        this.activeLayer = null
      }
    },
    mounted() {
      // draw map
      const paper = new spritejs.Scene('#paper', {
        resolution: [1000, 600],
        stickMode: 'width',
      })
      this.bgLayer = paper.layer()
      this.staticLayer = paper.layer()
      this.activeLayer = paper.layer()
      svgData.forEach(data => {
        const path = new Path()
        path.attr({
          name: data.name,
          fillColor: '#323c48',
          strokeColor: '#111',
          lineWidth: 0,
          d: data.d,
        })
        this.bgLayer.append(path)
      })

      // draw static float prov
      staticFloatProvs.forEach(item => {
        let path = this.bgLayer.children.find(child => {
          return child.name == item.name
        }).path
        this.drawCylinder({
          name: item.name,
          svgPath: path.d,
          zHeight: item.height,
          startColor: [26, 45, 115],
          endColor: [52, 81, 213],
          layer: this.staticLayer
        })
      })

      // add event listener
      this.bgLayer.on('click', event => {
        let targetSprite = event.targetSprites[0] || {}
        if (targetSprite.name) {
          this.drawActive(targetSprite)
        }
      })
    },
    methods: {
      /**
       * 绘制省份浮起效果 
       */
      drawCylinder({ name, svgPath, zHeight, startColor, endColor, layer, afterDraw }) {
        let offset = 1

        let rStepLenght = this.getStepLength(endColor[0], endColor[0], zHeight)
        let gStepLenght = this.getStepLength(endColor[1], endColor[1], zHeight)
        let bStepLenght = this.getStepLength(endColor[2], endColor[2], zHeight)

        for (let i = 0; i < zHeight; i++) {
          const path = new Path()
          let r = startColor[0] + rStepLenght * (i + 1),
            g = startColor[1] + gStepLenght * (i + 1),
            b = startColor[2] + bStepLenght * (i + 1);
          path.attr({
            name,
            fillColor: `rgb(${endColor[0]}, ${endColor[1]}, ${endColor[2]})`,
            strokeColor: `rgb(${r}, ${g}, ${b})`,
            d: svgPath,
            translate: [0, -(offset++)],
          })
          layer.append(path)

          afterDraw && afterDraw(path)
        }
      },

      /**
       * 绘制选中效果
       */
      drawActive(targetSprite) {
        // 清空已经绘制的图形
        this.activeSprites.forEach(item => {
          item.remove()
        })
        this.activeSprites = []

        // 绘制浮起的图层
        zHeight = 5
        let staticFloatProv = staticFloatProvs.find(item => {
          return item.name == targetSprite.name
        })
        if(staticFloatProv) {
          zHeight = staticFloatProv.height
        }

        this.drawCylinder({
          name: targetSprite.name,
          svgPath: targetSprite.path.d,
          zHeight,
          startColor: [129, 29, 44],
          endColor: [252, 47, 47],
          layer: this.activeLayer,
          afterDraw: (sprite) => {
            this.activeSprites.push(sprite)
          }
        })

        // 绘制侧边悬浮的弹窗
      },

      /**
       * 计算步长
       */
      getStepLength(end, start, steps) {
        return (end - start) / steps
      }
    }
  })
</script>

</html>